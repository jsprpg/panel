<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Créer un Serveur</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
</head>
<body>
    <div class="sidebar" th:insert="~{index :: .sidebar}"></div>
    <div class="main-content">
        <header class="header" th:insert="~{index :: .header}"></header>
        <main class="page-content">
            <h1>Créer un nouveau serveur</h1>
            
            <form th:action="@{/servers/create}" method="post">
                <div class="card" style="margin-bottom: 20px;">
                    <h2>1. Choisir une Catégorie</h2>
                    <div id="categories-grid" class="selection-grid">
                        </div>

                    <h2>2. Choisir une Sous-Catégorie</h2>
                    <div id="subcategories-grid" class="selection-grid" style="min-height: 100px;"></div>

                    <h2>3. Choisir un Egg</h2>
                    <div id="eggs-grid" class="selection-grid" style="min-height: 100px;"></div>
                    
                    <input type="hidden" name="dockerImage" id="selected-docker-image" required/>
                </div>

                <div class="card">
                    <h2>Configuration du serveur</h2>
                    
                    <label for="serverName">Nom du serveur :</label>
                    <input type="text" id="serverName" name="serverName" required>
                    <br><br>
                    
                    <label for="serverPort">Port (ex: 25565) :</label>
                    <input type="number" id="serverPort" name="serverPort" required>
                    <br><br>
                    
                    <label for="memory">RAM (en Mo) :</label>
                    <input type="number" id="memory" name="memory" required value="1024">
                    <br><br>
                    
                    <label for="cpu">CPU (cœurs) :</label>
                    <input type="number" id="cpu" name="cpu" step="0.1" required value="1.0">
                    <br><br>
                    
                    <label for="disk">Stockage (en Go) :</label>
                    <input type="number" id="disk" name="disk" required value="5">
                    <br><br>
                    
                    <button type="submit" class="action-btn btn-start">Créer le serveur</button>
                </div>
            </form>
        </main>
    </div>
    
    <script th:inline="javascript">
        const categoriesData = /*[[${nests}]]*/ {};
        const categoriesGrid = document.getElementById('categories-grid');
        const subcategoriesGrid = document.getElementById('subcategories-grid');
        const eggsGrid = document.getElementById('eggs-grid');
        const selectedDockerImageInput = document.getElementById('selected-docker-image');

        let activeCategoryCard = null;
        let activeSubCategoryCard = null;
        let activeEggCard = null;
        
        let selectedCategory = '';

        // Initialise les catégories
        Object.keys(categoriesData).forEach(categoryName => {
            const categoryCard = document.createElement('div');
            categoryCard.className = 'selection-card';
            categoryCard.dataset.categoryName = categoryName;
            categoryCard.innerHTML = `<i class="fa-solid fa-folder-tree"></i><h4>${categoryName}</h4>`;
            categoriesGrid.appendChild(categoryCard);
        });

        // Clic sur une catégorie
        categoriesGrid.addEventListener('click', (event) => {
            const card = event.target.closest('.selection-card');
            if (!card) return;

            if (activeCategoryCard) activeCategoryCard.classList.remove('active');
            card.classList.add('active');
            activeCategoryCard = card;
            
            selectedCategory = card.dataset.categoryName;
            const subcategories = categoriesData[selectedCategory];

            // Vide les grilles suivantes
            subcategoriesGrid.innerHTML = '';
            eggsGrid.innerHTML = '';
            if (activeSubCategoryCard) activeSubCategoryCard.classList.remove('active');
            if (activeEggCard) activeEggCard.classList.remove('active');
            selectedDockerImageInput.value = '';

            // Remplit la grille des sous-catégories
            Object.keys(subcategories).forEach(subCategoryName => {
                const subCategoryCard = document.createElement('div');
                subCategoryCard.className = 'selection-card';
                subCategoryCard.dataset.subCategoryName = subCategoryName;
                subCategoryCard.innerHTML = `<i class="fa-solid fa-layer-group"></i><h4>${subCategoryName}</h4>`;
                subcategoriesGrid.appendChild(subCategoryCard);
            });
        });
        
        // Clic sur une sous-catégorie
        subcategoriesGrid.addEventListener('click', (event) => {
            const card = event.target.closest('.selection-card');
            if (!card) return;

            if (activeSubCategoryCard) activeSubCategoryCard.classList.remove('active');
            card.classList.add('active');
            activeSubCategoryCard = card;

            const subCategoryName = card.dataset.subCategoryName;
            const eggs = categoriesData[selectedCategory][subCategoryName];
            
            // Vide la grille des eggs
            eggsGrid.innerHTML = '';
            if (activeEggCard) activeEggCard.classList.remove('active');
            selectedDockerImageInput.value = '';

            // Remplit la grille des eggs
            eggs.forEach(egg => {
                const eggCard = document.createElement('div');
                eggCard.className = 'selection-card';
                eggCard.dataset.dockerImage = egg.docker_image;
                eggCard.innerHTML = `<i class="fa-solid fa-egg"></i><h4>${egg.name}</h4>`;
                eggsGrid.appendChild(eggCard);
            });
        });

        // Clic sur un egg
        eggsGrid.addEventListener('click', (event) => {
            const card = event.target.closest('.selection-card');
            if (!card) return;
            
            if (activeEggCard) activeEggCard.classList.remove('active');
            card.classList.add('active');
            activeEggCard = card;
            
            selectedDockerImageInput.value = card.dataset.dockerImage;
        });
    </script>
</body>
</html>