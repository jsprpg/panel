<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Créer un Serveur</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
</head>
<body>
    <div class="sidebar" th:insert="~{index :: .sidebar}"></div>
    <div class="main-content">
        <header class="header" th:insert="~{index :: .header}"></header>
        <main class="page-content">
            <h1>Créer un nouveau serveur</h1>
            
            <form th:action="@{/servers/create}" method="post">
                <div class="card" style="margin-bottom: 20px;">
                    <h2>1. Choisir une Catégorie</h2>
                    <div id="categories-grid" class="selection-grid"></div>

                    <h2>2. Choisir une Sous-Catégorie</h2>
                    <div id="subcategories-grid" class="selection-grid" style="min-height: 100px;"></div>

                    <h2>3. Choisir un Egg</h2>
                    <div id="eggs-grid" class="selection-grid" style="min-height: 100px;"></div>
                    
                    <input type="hidden" name="dockerImage" id="selected-docker-image" required/>
                </div>

                <div class="card">
                    <h2>Configuration du serveur</h2>
                    
                    <label for="serverName">Nom du serveur :</label>
                    <input type="text" id="serverName" name="serverName" required>
                    <br><br>
                    
                    <label for="serverPort">Port principal :</label>
                    <input type="number" id="serverPort" name="serverPort" required>
                    <br><br>
                    
                    <label for="memory">RAM (en Mo) :</label>
                    <input type="number" id="memory" name="memory" required value="1024">
                    <br><br>
                    
                    <label for="cpu">CPU (cœurs) :</label>
                    <input type="number" id="cpu" name="cpu" step="0.1" required value="1.0">
                    <br><br>
                    
                    <label for="disk">Stockage (en Go) :</label>
                    <input type="number" id="disk" name="disk" required value="5">
                    <br><br>
                    
                    <button type="submit" class="action-btn btn-start">Créer le serveur</button>
                </div>
            </form>
        </main>
    </div>
    
    <script th:inline="javascript">
        const categoriesData = /*[[${nests}]]*/ {};
        const categoriesGrid = document.getElementById('categories-grid');
        const subcategoriesGrid = document.getElementById('subcategories-grid');
        const eggsGrid = document.getElementById('eggs-grid');
        const selectedDockerImageInput = document.getElementById('selected-docker-image');
        const serverPortInput = document.getElementById('serverPort');

        let activeCategoryCard, activeSubCategoryCard, activeEggCard, selectedCategory;

        Object.keys(categoriesData).forEach(categoryName => {
            const card = document.createElement('div');
            card.className = 'selection-card';
            card.dataset.categoryName = categoryName;
            card.innerHTML = `<i class="fa-solid fa-folder-tree"></i><h4>${categoryName}</h4>`;
            categoriesGrid.appendChild(card);
        });

        categoriesGrid.addEventListener('click', (event) => {
            const card = event.target.closest('.selection-card');
            if (!card) return;
            if (activeCategoryCard) activeCategoryCard.classList.remove('active');
            card.classList.add('active');
            activeCategoryCard = card;
            selectedCategory = card.dataset.categoryName;
            
            subcategoriesGrid.innerHTML = '';
            eggsGrid.innerHTML = '';
            if (activeSubCategoryCard) activeSubCategoryCard.classList.remove('active');
            if (activeEggCard) activeEggCard.classList.remove('active');
            selectedDockerImageInput.value = '';
            serverPortInput.value = '';
            serverPortInput.readOnly = false;

            Object.keys(categoriesData[selectedCategory]).forEach(subCategoryName => {
                const subCard = document.createElement('div');
                subCard.className = 'selection-card';
                subCard.dataset.subCategoryName = subCategoryName;
                subCard.innerHTML = `<i class="fa-solid fa-layer-group"></i><h4>${subCategoryName}</h4>`;
                subcategoriesGrid.appendChild(subCard);
            });
        });
        
        subcategoriesGrid.addEventListener('click', (event) => {
            const card = event.target.closest('.selection-card');
            if (!card) return;
            if (activeSubCategoryCard) activeSubCategoryCard.classList.remove('active');
            card.classList.add('active');
            activeSubCategoryCard = card;
            const subCategoryName = card.dataset.subCategoryName;
            
            eggsGrid.innerHTML = '';
            if (activeEggCard) activeEggCard.classList.remove('active');
            selectedDockerImageInput.value = '';
            serverPortInput.value = '';
            serverPortInput.readOnly = false;

            categoriesData[selectedCategory][subCategoryName].forEach(egg => {
                const eggCard = document.createElement('div');
                eggCard.className = 'selection-card';
                eggCard.dataset.dockerImage = egg.docker_image;
                eggCard.dataset.eggInfo = JSON.stringify(egg);
                eggCard.innerHTML = `<i class="fa-solid fa-egg"></i><h4>${egg.name}</h4>`;
                eggsGrid.appendChild(eggCard);
            });
        });

        eggsGrid.addEventListener('click', (event) => {
            const card = event.target.closest('.selection-card');
            if (!card) return;
            if (activeEggCard) activeEggCard.classList.remove('active');
            card.classList.add('active');
            activeEggCard = card;
            
            selectedDockerImageInput.value = card.dataset.dockerImage;
            
            const eggInfo = JSON.parse(card.dataset.eggInfo);
            
            // On remplit le port
            if (eggInfo.ports && Object.keys(eggInfo.ports).length > 0) {
                const primaryPort = Object.keys(eggInfo.ports)[0];
                serverPortInput.value = primaryPort;
            } else {
                serverPortInput.value = '';
            }

            // On verrouille le port SAUF si c'est un serveur Minecraft
            if (eggInfo.docker_image && eggInfo.docker_image.includes('itzg/minecraft-server')) {
                serverPortInput.readOnly = false;
            } else {
                serverPortInput.readOnly = true;
            }
        });
    </script>
</body>
</html>